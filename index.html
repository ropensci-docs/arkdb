<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Flat text files provide a robust, compressible, and portable
  way to store tables from databases.  This package provides convenient
  functions for exporting tables from relational database connections
  into compressed text files and streaming those text files back into
  a database without requiring the whole table to fit in working memory.">
<title>Archive and Unarchive Databases Using Flat Files • arkdb</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Archive and Unarchive Databases Using Flat Files">
<meta property="og:description" content="Flat text files provide a robust, compressible, and portable
  way to store tables from databases.  This package provides convenient
  functions for exporting tables from relational database connections
  into compressed text files and streaming those text files back into
  a database without requiring the whole table to fit in working memory.">
<meta property="og:image" content="https://docs.ropensci.org/arkdb/logo.svg">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="index.html">arkdb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.18</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="articles/arkdb.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/noapi.html">Working with medium-sized data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/arkdb/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.svg" class="logo" alt=""><h1 id="arkdb-">arkdb <a class="anchor" aria-label="anchor" href="#arkdb-"></a>
</h1>
</div>
<p><a href="https://github.com/ropensci/arkdb/actions" class="external-link"><img src="https://github.com/ropensci/arkdb/workflows/R-CMD-check/badge.svg" alt="R build status"></a> <a href="https://app.travis-ci.com/ropensci/arkdb" class="external-link"><img src="https://app.travis-ci.com/ropensci/arkdb.svg?branch=master" alt="Travis build status"></a> <a href="https://app.codecov.io/github/ropensci/arkdb?branch=master" class="external-link"><img src="https://codecov.io/gh/ropensci/arkdb/branch/master/graph/badge.svg" alt="Coverage status"></a> <a href="https://cran.r-project.org/package=arkdb" class="external-link"><img src="http://www.r-pkg.org/badges/version/arkdb" alt="CRAN_Status_Badge"></a> <a href="https://github.com/ropensci/software-review/issues/224" class="external-link"><img src="https://badges.ropensci.org/224_status.svg"></a> <a href="https://lifecycle.r-lib.org/articles/stages.html" class="external-link"><img src="https://img.shields.io/badge/lifecycle-stable-brightgreen.svg" alt="lifecycle"></a> <a href="https://CRAN.R-project.org/package=arkdb" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/grand-total/arkdb" alt="CRAN RStudio mirror downloads"></a> <a href="https://doi.org/10.5281/zenodo.1343943" class="external-link"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.1343943.svg" alt="DOI"></a> <!-- badges: end --></p>
<!-- README.md is generated from README.Rmd. Please edit that file --><p>The goal of <code>arkdb</code> is to provide a convenient way to move data from large compressed text files (tsv, csv, etc) into any DBI-compliant database connection (e.g. MYSQL, Postgres, SQLite; see <a href="https://solutions.rstudio.com/db/r-packages/DBI/" class="external-link">DBI</a>), and move tables out of such databases into text files. The key feature of <code>arkdb</code> is that files are moved between databases and text files in chunks of a fixed size, allowing the package functions to work with tables that would be much too large to read into memory all at once. There is also functionality for filtering and applying transformation to data as it is extracted from the database.</p>
<p>The <code>arkdb</code> package is easily extended to use custom read and write methods allowing you to dictate your own output formats. See <code>R/streamable_table.R</code> for examples that include using:</p>
<ul>
<li>Base c/tsv</li>
<li>Apache arrow’s parquet</li>
<li>The <code>readr</code> package for c/tsv</li>
</ul>
<div class="section level2">
<h2 id="links">Links<a class="anchor" aria-label="anchor" href="#links"></a>
</h2>
<ul>
<li>A more detailed introduction to package design and use can be found in the package <a href="https://docs.ropensci.org/arkdb/articles/arkdb.html">Vignette</a>
</li>
<li><a href="https://docs.ropensci.org/arkdb/">Online versions of package documentation</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install arkdb from GitHub with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"cboettig/arkdb"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="basic-use">Basic use<a class="anchor" aria-label="anchor" href="#basic-use"></a>
</h1>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/arkdb">arkdb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># additional libraries just for this demo</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="creating-an-archive-of-a-database">Creating an archive of a database<a class="anchor" aria-label="anchor" href="#creating-an-archive-of-a-database"></a>
</h2>
<p>Consider the <code>nycflights</code> database in SQLite:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Or can be your working directory, "."</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/nycflights13.html" class="external-link">nycflights13_sqlite</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Caching nycflights db at /tmp/Rtmpm6YZ0e/nycflights13.sqlite</span></span>
<span><span class="co">#&gt; Creating table: airlines</span></span>
<span><span class="co">#&gt; Creating table: airports</span></span>
<span><span class="co">#&gt; Creating table: flights</span></span>
<span><span class="co">#&gt; Creating table: planes</span></span>
<span><span class="co">#&gt; Creating table: weather</span></span></code></pre></div>
<p>Create an archive of the database:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"nycflights"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, lines <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Exporting airlines in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.005531788 secs)</span></span>
<span><span class="co">#&gt; Exporting airports in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.02239442 secs)</span></span>
<span><span class="co">#&gt; Exporting flights in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 11.78997 secs)</span></span>
<span><span class="co">#&gt; Exporting planes in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.03349638 secs)</span></span>
<span><span class="co">#&gt; Exporting weather in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.8155148 secs)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="unarchive">Unarchive<a class="anchor" aria-label="anchor" href="#unarchive"></a>
</h2>
<p>Import a list of compressed tabular files (i.e. <code>*.csv.bz2</code>) into a local SQLite database:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span></span>
<span><span class="va">new_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"local.sqlite"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/unark.html">unark</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">new_db</span>, lines <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmpm6YZ0e/nycflights/airlines.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.0131464 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmpm6YZ0e/nycflights/airports.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.02401853 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmpm6YZ0e/nycflights/flights.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 7.150884 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmpm6YZ0e/nycflights/planes.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.0348866 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmpm6YZ0e/nycflights/weather.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.2378168 secs)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-filters">Using filters<a class="anchor" aria-label="anchor" href="#using-filters"></a>
</h2>
<p>This package can also be used to generate slices of data that are required for analytical or operational purposes. In the example below we archive to disk only the flight data that occurred in the month of December. It is recommended to use filters on a single table at a time.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, lines <span class="op">=</span> <span class="fl">50000</span>, tables <span class="op">=</span> <span class="st">"flights"</span>, filter_statement <span class="op">=</span> <span class="st">"WHERE month = 12"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-callbacks">Using callbacks<a class="anchor" aria-label="anchor" href="#using-callbacks"></a>
</h2>
<p>It is possible to use a callback to perform just-in-time data transformations before ark writes your data object to disk in your preferred format. In the example below, we write a simple transformation to convert the flights data <code>arr_delay</code> field, from minutes, to hours. It is recommended to use callbacks on a single table at a time. A callback function can be anything you can imagine so long as it returns a data.frame that can be written to disk.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mins_to_hours</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">arr_delay</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">arr_delay</span><span class="op">/</span><span class="fl">60</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, lines <span class="op">=</span> <span class="fl">50000</span>, tables <span class="op">=</span> <span class="st">"flights"</span>, callback <span class="op">=</span> <span class="va">mins_to_hours</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="ark-in-parallel">ark() in parallel<a class="anchor" aria-label="anchor" href="#ark-in-parallel"></a>
</h2>
<p>There are two strategies for using <code>ark</code> in parallel. One is to loop over the tables, re-using the ark function per table in parallel. The other, introduced in 0.0.15, is to use the “window-parallel” method which loops over chunks of your table. This is particularly useful if your tables are very large and can speed up the process significantly.</p>
<p>Note: <code>window-parallel</code> currently only works in conjunction with <code>streamable_parquet</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strategy 1: Parallel over tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/arkdb">arkdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Any streamable_table method is acceptable</span></span>
<span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">vector_of_tables</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, <span class="va">lines</span>, tables <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strategy 2: Parallel over chunks of a table</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/arkdb">arkdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span></span>
<span>  <span class="va">db</span>, </span>
<span>  <span class="va">dir</span>, </span>
<span>  streamable_table <span class="op">=</span> <span class="fu"><a href="reference/streamable_parquet.html">streamable_parquet</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># required for window-parallel</span></span>
<span>  lines <span class="op">=</span> <span class="fl">50000</span>, </span>
<span>  tables <span class="op">=</span> <span class="st">"flights"</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"window-parallel"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strategy 3: Parallel over tables and chunks of tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/arkdb">arkdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span><span class="co"># 16 core machine for example</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4 tables at a time, 4 threads per table</span></span>
<span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">vector_of_tables</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span></span>
<span>    <span class="va">db</span>, </span>
<span>    <span class="va">dir</span>, </span>
<span>    streamable_table <span class="op">=</span> <span class="fu"><a href="reference/streamable_parquet.html">streamable_parquet</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># required for window-parallel</span></span>
<span>    lines <span class="op">=</span> <span class="fl">50000</span>, </span>
<span>    tables <span class="op">=</span> <span class="va">x</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"window-parallel"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="etls-with-arkdb">ETLs with arkdb<a class="anchor" aria-label="anchor" href="#etls-with-arkdb"></a>
</h2>
<p>The <code>arkdb</code> package can also be used to create a number of ETL pipelines involving text archives or databases given its ability to filter, and use callbacks. In the example below, we leverage <code>duckdb</code> to read a fictional folder of files by US state, filter by <code>var_filtered</code>, apply a callback transformation <code>transform_fun</code> to <code>var_transformed</code> save as parquet, and then load a folder of parquet files for analysis with Apache Arrow.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.duckdb.org/" class="external-link">duckdb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">transform_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">var_transformed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">var_transformed</span><span class="op">)</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">state</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DC"</span>, <span class="va">state.abb</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"path/to/archives/"</span>, <span class="va">state</span>, <span class="st">".gz"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="reference/ark.html">ark</a></span><span class="op">(</span></span>
<span>    <span class="va">db</span>,</span>
<span>    dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"output/"</span>, <span class="va">state</span><span class="op">)</span>,</span>
<span>    streamable_table <span class="op">=</span> <span class="fu"><a href="reference/streamable_parquet.html">streamable_parquet</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># parquet files of nline rows</span></span>
<span>    lines <span class="op">=</span> <span class="fl">100000</span>,</span>
<span>    <span class="co"># See: https://duckdb.org/docs/data/csv</span></span>
<span>    tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"read_csv_auto('%s')"</span>, <span class="va">path</span><span class="op">)</span>, </span>
<span>    compress <span class="op">=</span> <span class="st">"none"</span>, <span class="co"># Compression meaningless for parquet as it's already compressed</span></span>
<span>    overwrite <span class="op">=</span> <span class="cn">T</span>, </span>
<span>    filenames <span class="op">=</span> <span class="va">state</span>, <span class="co"># Overload tablename</span></span>
<span>    filter_statement <span class="op">=</span> <span class="st">"WHERE var_filtered = 1"</span>,</span>
<span>    callback <span class="op">=</span> <span class="va">transform_fun</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># The result is trivial to read in with arrow </span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="st">"output"</span>, partitioning <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></span></code></pre></div>
<hr>
<p>Please note that this project is released with a <a href="https://ropensci.org/code-of-conduct/" class="external-link">Contributor Code of Conduct</a>. By participating in this project you agree to abide by its terms.</p>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=arkdb" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/ropensci/arkdb/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/ropensci/arkdb/issues" class="external-link">Report a bug</a></li>
</ul>
</div>



<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing arkdb</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Carl Boettiger <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0002-1642-628X" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="r-universe">
<h2 data-toc-skip>R-universe</h2>
<ul class="list-unstyled">
<li><p><a href="https://ropensci.r-universe.dev/arkdb" class="external-link"><img src="https://ropensci.r-universe.dev/badges/arkdb" alt="arkdb status badge"></a></p></li>
</ul>
</div>

<div class="software-peer-review">
<h2 data-toc-skip>Software Peer-Review</h2>
<ul class="list-unstyled">
<li><p><a href="https://github.com/ropensci/software-review/issues/224" class="external-link"><img src="https://badges.ropensci.org/224_status.svg" alt="rOpenSci peer-review"></a></p></li>
</ul>
</div>

  </aside>
</div>


    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
