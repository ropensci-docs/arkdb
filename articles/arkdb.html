<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="arkdb">
<title>Introduction to arkdb • arkdb</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to arkdb">
<meta property="og:description" content="arkdb">
<meta property="og:image" content="https://docs.ropensci.org/arkdb/logo.svg">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">arkdb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.18</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="active nav-item">
  <a class="nav-link" href="../articles/arkdb.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/noapi.html">Working with medium-sized data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/arkdb/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Introduction to arkdb</h1>
                        <h4 data-toc-skip class="author">Carl Boettiger</h4>
            
            <h4 data-toc-skip class="date">2024-03-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/arkdb/blob/HEAD/vignettes/arkdb.Rmd" class="external-link"><code>vignettes/arkdb.Rmd</code></a></small>
      <div class="d-none name"><code>arkdb.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="arkdb">arkdb<a class="anchor" aria-label="anchor" href="#arkdb"></a>
</h2>
<div class="section level3">
<h3 id="package-rationale">Package rationale<a class="anchor" aria-label="anchor" href="#package-rationale"></a>
</h3>
<p>Increasing data sizes create challenges for the fundamental tasks of publishing, distributing, and preserving data. Despite (or perhaps because of) the diverse and ever-expanding number of database and file formats, the humble plain text file such as comma or tab-separated-values (e.g. <code>.csv</code> or <code>.tsv</code> files) remains the gold standard for data archiving and distribution. These files can read on almost any platform or tool and can be efficiently compressed using long-standing and widely available standard open source libraries like <code>gzip</code> or <code>bzip2</code>. In contrast, database storage formats and dumps are usually particular to the database platform used to generate them, and will likely not be compatible between different database engines (e.g. PostgreSQL -&gt; SQLite) or even between different versions of the same engine. Researchers unfamiliar with these databases will have difficulty accessing such data, and these dumps may also be in formats that are less efficient to compress.</p>
<p>Working with tables that are too large for working memory on most machines by using external relational database stores is now a common R practice, thanks to ever-rising availability of data and increasing support and popularity of packages such as <code>DBI</code>, <code>dplyr</code>, and <code>dbplyr</code>. Working with plain text files becomes increasingly difficult in this context. Many R users will not have sufficient RAM to simply read in a 10 GB <code>.tsv</code> file into R. Similarly, moving a 10 GB database out of a relational data file and into a plain text file for archiving and distribution is similarly challenging from R. While most relational database back-ends implement some form of <code>COPY</code> or <code>IMPORT</code> that allows them to read in and export out plain text files directly, these methods are not consistent across database types and not part of the standard SQL interface. Most importantly for our case, they also cannot be called directly from R, but require a separate stand-alone installation of the database client. <code>arkdb</code> provides a simple solution to these two tasks.</p>
<p>The goal of <code>arkdb</code> is to provide a convenient way to move data from large compressed text files (e.g. <code>*.tsv.bz2</code>) into any DBI-compliant database connection (see <a href="https://solutions.rstudio.com/db/r-packages/DBI/" class="external-link">DBI</a>), and move tables out of such databases into text files. The key feature of <code>arkdb</code> is that files are moved between databases and text files in chunks of a fixed size, allowing the package functions to work with tables that would be much to large to read into memory all at once. This will be slower than reading the file into memory at one go, but can be scaled to larger data and larger data with no additional memory requirement.</p>
</div>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>You can install <code>arkdb</code> from GitHub with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"cboettig/arkdb"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="tutorial">Tutorial<a class="anchor" aria-label="anchor" href="#tutorial"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/arkdb">arkdb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># additional libraries just for this demo</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13" class="external-link">nycflights13</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="creating-an-archive-of-an-existing-database">Creating an archive of an existing database<a class="anchor" aria-label="anchor" href="#creating-an-archive-of-an-existing-database"></a>
</h3>
<p>First, we’ll need an example database to work with. Conveniently, there is a nice example using the NYC flights data built into the <code>dbplyr</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Or can be your working directory, "."</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/nycflights13.html" class="external-link">nycflights13_sqlite</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Caching nycflights db at /tmp/Rtmp71jA3Z/nycflights13.sqlite</span></span>
<span><span class="co">#&gt; Creating table: airlines</span></span>
<span><span class="co">#&gt; Creating table: airports</span></span>
<span><span class="co">#&gt; Creating table: flights</span></span>
<span><span class="co">#&gt; Creating table: planes</span></span>
<span><span class="co">#&gt; Creating table: weather</span></span></code></pre></div>
<p>To create an archive, we just give <code>ark</code> the connection to the database and tell it where we want the <code>*.tsv.bz2</code> files to be archived. We can also set the chunk size as the number of <code>lines</code> read in a single chunk. More lines per chunk usually means faster run time at the cost of higher memory requirements.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"nycflights"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, lines <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Exporting airlines in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.003984928 secs)</span></span>
<span><span class="co">#&gt; Exporting airports in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01179194 secs)</span></span>
<span><span class="co">#&gt; Exporting flights in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 5.810223 secs)</span></span>
<span><span class="co">#&gt; Exporting planes in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01563001 secs)</span></span>
<span><span class="co">#&gt; Exporting weather in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.4196997 secs)</span></span></code></pre></div>
<p>We can take a look and confirm the files have been written. Note that we can use <code><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">fs::dir_info</a></code> to get a nice snapshot of the file sizes. Compare the compressed sizes to the original database:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_info</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">size</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_file.html" class="external-link">path_file</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span></span>
<span><span class="co">#&gt;   path                    size</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;fs::bytes&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> airlines.tsv.bz2         260</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> airports.tsv.bz2      28.13K</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> flights.tsv.bz2        4.85M</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> planes.tsv.bz2        11.96K</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> weather.tsv.bz2      278.84K</span></span>
<span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_info.html" class="external-link">file_info</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>,<span class="st">"nycflights13.sqlite"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="co">#&gt; 44.9M</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="unarchive">Unarchive<a class="anchor" aria-label="anchor" href="#unarchive"></a>
</h3>
<p>Now that we’ve gotten all the database into (compressed) plain text files, let’s get them back out. We simply need to pass <code>unark</code> a list of these compressed files and a connection to the database. Here we create a new local SQLite database. Note that this design means that it is also easy to use <code>arkdb</code> to move data between databases.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">dir</span>, glob <span class="op">=</span> <span class="st">"*.tsv.bz2"</span><span class="op">)</span></span>
<span><span class="va">new_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"local.sqlite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As with <code>ark</code>, we can set the chunk size to control the memory footprint required:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unark.html">unark</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">new_db</span>, lines <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span>  </span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/airlines.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.007319927 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/airports.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01323366 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/flights.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 3.509614 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/planes.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01924562 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/weather.tsv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.1440406 secs)</span></span></code></pre></div>
<p><code>unark</code> returns a <code>dplyr</code> database connection that we can use in the usual way:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">new_db</span>, <span class="st">"flights"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;flights&gt; [?? x 19]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.45.0 [/tmp/Rtmp71jA3Z/local.sqlite]</span></span></span>
<span><span class="co">#&gt;     year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">2</span>013     1     1      517            515         2      830            819</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">2</span>013     1     1      533            529         4      850            830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">2</span>013     1     1      542            540         2      923            850</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">2</span>013     1     1      544            545        -<span style="color: #BB0000;">1</span>     <span style="text-decoration: underline;">1</span>004           <span style="text-decoration: underline;">1</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>013     1     1      554            600        -<span style="color: #BB0000;">6</span>      812            837</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>013     1     1      554            558        -<span style="color: #BB0000;">4</span>      740            728</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>013     1     1      555            600        -<span style="color: #BB0000;">5</span>      913            854</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>013     1     1      557            600        -<span style="color: #BB0000;">3</span>      709            723</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>013     1     1      557            600        -<span style="color: #BB0000;">3</span>      838            846</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>013     1     1      558            600        -<span style="color: #BB0000;">2</span>      753            745</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more variables: arr_delay &lt;int&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;int&gt;, distance &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   hour &lt;int&gt;, minute &lt;int&gt;, time_hour &lt;dbl&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove example files we created.</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">new_db</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">dir</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"local.sqlite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pluggable-text-formats">Pluggable text formats<a class="anchor" aria-label="anchor" href="#pluggable-text-formats"></a>
</h3>
<p>By default, <code>arkdb</code> uses <code>tsv</code> format, implemented in base tools, as the text-based serialization. The <code>tsv</code> standard is particularly attractive because it side-steps some of the ambiguities present in the CSV format due to string quoting. The <a href="https://www.iana.org/assignments/media-types/text/tab-separated-values" class="external-link">IANA Standard for TSV</a> neatly avoids this for tab-separated values by insisting that a tab can only ever be a separator.</p>
<p><code>arkdb</code> provides a pluggable mechanism for changing the back end utility used to write text files. For instance, if we need to read in or export in <code>.csv</code> format, we can simply swap in a <code>csv</code> based reader in both <code><a href="../reference/ark.html">ark()</a></code> and <code><a href="../reference/unark.html">unark()</a></code> methods, as illustrated here:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"nycflights"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, </span>
<span>    streamable_table <span class="op">=</span> <span class="fu"><a href="../reference/streamable_base_csv.html">streamable_base_csv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Exporting airlines in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.001810789 secs)</span></span>
<span><span class="co">#&gt; Exporting airports in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01095533 secs)</span></span>
<span><span class="co">#&gt; Exporting flights in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 6.050243 secs)</span></span>
<span><span class="co">#&gt; Exporting planes in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.0166409 secs)</span></span>
<span><span class="co">#&gt; Exporting weather in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.4223397 secs)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">dir</span>, glob <span class="op">=</span> <span class="st">"*.csv.bz2"</span><span class="op">)</span></span>
<span><span class="va">new_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="st">"local.sqlite"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/unark.html">unark</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">new_db</span>,</span>
<span>      streamable_table <span class="op">=</span> <span class="fu"><a href="../reference/streamable_base_csv.html">streamable_base_csv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/airlines.csv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.007172108 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/airports.csv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01322842 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/flights.csv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 3.673843 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/planes.csv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.01932621 secs)</span></span>
<span><span class="co">#&gt; Importing /tmp/Rtmp71jA3Z/nycflights/weather.csv.bz2 in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.1897376 secs)</span></span></code></pre></div>
<p><code>arkdb</code> also provides the function <code><a href="../reference/streamable_table.html">streamable_table()</a></code> to facilitate users creating their own streaming table interfaces. For instance, if you would prefer to use <code>readr</code> methods to read and write <code>tsv</code> files, we could construct the table as follows (<code><a href="../reference/streamable_readr_tsv.html">streamable_readr_tsv()</a></code> and <code><a href="../reference/streamable_readr_csv.html">streamable_readr_csv()</a></code> are also shipped inside <code>arkdb</code> for convenience):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stream</span> <span class="op">&lt;-</span> </span>
<span>   <span class="fu"><a href="../reference/streamable_table.html">streamable_table</a></span><span class="op">(</span></span>
<span>     <span class="kw">function</span><span class="op">(</span><span class="va">file</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">file</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>     <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">path</span>, <span class="va">omit_header</span><span class="op">)</span></span>
<span>       <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, path <span class="op">=</span> <span class="va">path</span>, append <span class="op">=</span> <span class="va">omit_header</span><span class="op">)</span>,</span>
<span>     <span class="st">"tsv"</span><span class="op">)</span></span></code></pre></div>
<p>and we can then pass such a streamable table directly to <code><a href="../reference/ark.html">ark()</a></code> and <code><a href="../reference/unark.html">unark()</a></code>, like so:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ark.html">ark</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">dir</span>, </span>
<span>    streamable_table <span class="op">=</span> <span class="va">stream</span><span class="op">)</span></span>
<span><span class="co">#&gt; Exporting airlines in 50000 line chunks:</span></span>
<span><span class="co">#&gt; Warning: The `path` argument of `write_tsv()` is deprecated as of readr 1.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use the `file` argument instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt;  ...Done! (in 0.1260805 secs)</span></span>
<span><span class="co">#&gt; Exporting airports in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.05660677 secs)</span></span>
<span><span class="co">#&gt; Exporting flights in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 2.95391 secs)</span></span>
<span><span class="co">#&gt; Exporting planes in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.03582048 secs)</span></span>
<span><span class="co">#&gt; Exporting weather in 50000 line chunks:</span></span>
<span><span class="co">#&gt;  ...Done! (in 0.2343223 secs)</span></span></code></pre></div>
<p>Note several constraints on this design. The write method must be able to take a generic R <code>connection</code> object (which will allow it to handle the compression methods used, if any), and the read method must be able to take a <code>textConnection</code> object. <code>readr</code> functions handle these cases out of the box, so the above method is easy to write. Also note that the write method must be able to <code>append</code>, i.e. it should use a header if <code>append=TRUE</code>, but omit when it is <code>FALSE</code>. See the built-in methods for more examples.</p>
</div>
<div class="section level3">
<h3 id="a-note-on-compression">A note on compression<a class="anchor" aria-label="anchor" href="#a-note-on-compression"></a>
</h3>
<p><code>unark</code> can read from a variety of compression formats recognized by base R: <code>bzip2</code>, <code>gzip</code>, <code>zip</code>, and <code>xz</code>, and <code>ark</code> can choose any of these as the compression algorithm. Note that there is some trade-off between speed of compression and efficiency (i.e. the final file size). <code>ark</code> uses the <code>bz2</code> compression algorithm by default, supported in base R, to compress <code>tsv</code> files. The <code>bz2</code> offers excellent compression levels, but is considerably slower to compress than <code>gzip</code> or <code>zip</code>. It is comparably fast to uncompress. For faster archiving when maximum file size reduction is not critical, <code>gzip</code> will give nearly as effective compression in significantly less time. Compression can also be turned off, e.g. by using <code><a href="../reference/ark.html">ark()</a></code> with <code>compress="none"</code> and <code><a href="../reference/unark.html">unark()</a></code> with files that have no compression suffix (e.g. <code>*.tsv</code> instead of <code>*.tsv.gz</code>).</p>
</div>
<div class="section level3">
<h3 id="distributing-data">Distributing data<a class="anchor" aria-label="anchor" href="#distributing-data"></a>
</h3>
<p>Once you have archived your database files with <code>ark</code>, consider sharing them privately or publicly as part of your project GitHub repo using the <a href="https://github.com/ropensci/piggyback" class="external-link"><code>piggyback</code> R package</a>. For more permanent, versioned, and citable data archiving, upload your <code>*.tsv.bz2</code> files to a data repository like <a href="https://zenodo.org" class="external-link">Zenodo.org</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
